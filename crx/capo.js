(()=>{function e(e,t,n,i){Object.defineProperty(e,t,{get:n,set:i,enumerable:!0,configurable:!0})}function t(e){return[`oklch(5% .1 ${e})`,`oklch(13% .2 ${e})`,`oklch(25% .2 ${e})`,`oklch(35% .25 ${e})`,`oklch(50% .27 ${e})`,`oklch(67% .31 ${e})`,`oklch(72% .25 ${e})`,`oklch(80% .2 ${e})`,`oklch(90% .1 ${e})`,`oklch(99% .05 ${e})`,"#ccc"]}let n=["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2","#cccccc"],i=t(320),a=t(200),s={DEFAULT:n,PINK:i,BLUE:a};var r={};e(r,"IO",()=>o);class o{constructor(e,t,n=window.console){this.document=e,this.options=t,this.console=n,this.isStaticHead=!1,this.head=null}async init(){if(!this.head){if(this.options.prefersDynamicAssessment()){this.head=this.document.querySelector("head");return}try{let e=await this.getStaticHTML();e=e.replace(/(\<\/?)(head)/gi,"$1static-head");let t=this.document.implementation.createHTMLDocument("New Document");t.documentElement.innerHTML=e,this.head=t.querySelector("static-head"),this.head?this.isStaticHead=!0:this.head=this.document.head}catch(e){this.console.error(`${this.options.loggingPrefix}An exception occurred while getting the static <head>:`,e),this.head=this.document.head}this.isStaticHead||this.console.warn(`${this.options.loggingPrefix}Unable to parse the static (server-rendered) <head>. Falling back to document.head`,this.head)}}async getStaticHTML(){let e=this.document.location.href,t=await fetch(e);return await t.text()}getHead(){return this.head}stringifyElement(e){return e.getAttributeNames().reduce((t,n)=>t+=`[${CSS.escape(n)}=${JSON.stringify(e.getAttribute(n))}]`,e.nodeName)}getLoggableElement(e){if(!this.isStaticHead)return e;let t=this.stringifyElement(e),n=Array.from(this.document.head.querySelectorAll(t));if(0==n.length)return e;if(1==n.length)return n[0];let i=this.document.createElement("div"),a=this.document.createElement("div");a.innerHTML=e.innerHTML;let s=n.find(e=>(i.innerHTML=e.innerHTML,i.innerHTML==a.innerHTML));return s||e}createElementFromSelector(e){let t=e.match(/^[A-Za-z]+/)[0];if(!t)return;let n=document.createElement(t),i=e.match(/\[([A-Za-z-]+)="([^"]+)"\]/g)||[];return i.forEach(e=>{e=e.slice(1,-1);let t=e.indexOf("="),i=e.slice(0,t),a=e.slice(t+1).slice(1,-1);n.setAttribute(i,a)}),n}logElementFromSelector({weight:e,selector:t,innerHTML:n,isValid:i,customValidations:a={}}){e=+e;let s=this.getElementVisualization(e),r=this.createElementFromSelector(t);r.innerHTML=n,r=this.getLoggableElement(r),this.logElement({viz:s,weight:e,element:r,isValid:i,customValidations:a})}logElement({viz:e,weight:t,element:n,isValid:i,customValidations:a,omitPrefix:s=!1}){s||(e.visual=`${this.options.loggingPrefix}${e.visual}`);let r="log",o=[e.visual,e.style,t+1,n];if(!this.options.isValidationEnabled()){this.console[r](...o);return}let{payload:l,warnings:c}=a;l&&("string"==typeof l.expiry&&(l.expiry=new Date(l.expiry)),o.push(l)),c?.length?(r="warn",o.push("\n"+c.map(e=>`  ❌ ${e}`).join("\n"))):!i&&(this.options.prefersDynamicAssessment()||this.isStaticHead)&&(r="warn",o.push(`
  ❌ invalid element (${n.tagName})`)),this.console[r](...o)}logValidationWarnings(e){this.options.isValidationEnabled()&&e.forEach(({warning:e,elements:t=[],element:n})=>{t=t.map(this.getLoggableElement.bind(this)),this.console.warn(`${this.options.loggingPrefix}${e}`,...t,n||"")})}getColor(e){return this.options.palette[10-e]}getHeadVisualization(e){let t="",n=[];return e.forEach(({weight:e,isValid:i})=>{t+="%c ";let a=this.getColor(e),s="padding: 5px; margin: 0 -1px; ";if(i)s+=`background-color: ${a};`;else{let e;s+=`background-image: ${a==(e="#cccccc")&&(e="red"),`repeating-linear-gradient(45deg, ${a}, ${a} 3px, ${e} 3px, ${e} 6px)`}`}n.push(s)}),{visual:t,styles:n}}getElementVisualization(e){let t=`%c${Array(e+1).fill("█").join("")}`,n=this.getColor(e),i=`color: ${n}`;return{visual:t,style:i}}visualizeHead(e,t,n){let i=this.getHeadVisualization(n);this.console.groupCollapsed(`${this.options.loggingPrefix}${e} %chead%c order
${i.visual}`,"font-family: monospace","font-family: inherit",...i.styles),n.forEach(({weight:e,element:t,isValid:n,customValidations:i})=>{let a=this.getElementVisualization(e);this.logElement({viz:a,weight:e,element:t,isValid:n,customValidations:i,omitPrefix:!0})}),this.console.log(`${e} %chead%c element`,"font-family: monospace","font-family: inherit",t),this.console.groupEnd()}}var l={};e(l,"Options",()=>c);class c{constructor({preferredAssessmentMode:e=c.AssessmentMode.STATIC,validation:t=!0,palette:i=n,loggingPrefix:a="Capo: "}={}){this.setPreferredAssessmentMode(e),this.setValidation(t),this.setPalette(i),this.setLoggingPrefix(a)}static get AssessmentMode(){return{STATIC:"static",DYNAMIC:"dynamic"}}static get Palettes(){return s}prefersStaticAssessment(){return this.preferredAssessmentMode===c.AssessmentMode.STATIC}prefersDynamicAssessment(){return this.preferredAssessmentMode===c.AssessmentMode.DYNAMIC}isValidationEnabled(){return this.validation}setPreferredAssessmentMode(e){if(!this.isValidAssessmentMode(e))throw Error(`Invalid option: preferred assessment mode, expected AssessmentMode.STATIC or AssessmentMode.DYNAMIC, got "${e}".`);this.preferredAssessmentMode=e}setPreferredAssessmentModeToStatic(e){let t=c.AssessmentMode.STATIC;e||(t=c.AssessmentMode.DYNAMIC),this.setPreferredAssessmentMode(t)}setValidation(e){if(!this.isValidValidation(e))throw Error(`Invalid option: validation, expected boolean, got "${e}".`);this.validation=e}setPalette(e){if(!this.isValidPalette(e))throw Error(`Invalid option: palette, expected [${Object.keys(s).join("|")}] or an array of colors, got "${e}".`);if("string"==typeof e){this.palette=s[e];return}this.palette=e}setLoggingPrefix(e){if(!this.isValidLoggingPrefix(e))throw Error(`Invalid option: logging prefix, expected string, got "${e}".`);this.loggingPrefix=e}isValidAssessmentMode(e){return Object.values(c.AssessmentMode).includes(e)}isValidValidation(e){return"boolean"==typeof e}isValidPalette(e){return"string"==typeof e?Object.keys(s).includes(e):!!Array.isArray(e)&&11===e.length&&e.every(e=>"string"==typeof e)}isValidLoggingPrefix(e){return"string"==typeof e}isPreferredPalette(e){return JSON.stringify(this.palette)==JSON.stringify(e)}valueOf(){return{preferredAssessmentMode:this.preferredAssessmentMode,validation:this.validation,palette:this.palette,loggingPrefix:this.loggingPrefix}}}var h={};e(h,"ElementWeights",()=>d),e(h,"ElementDetectors",()=>u),e(h,"isMeta",()=>g),e(h,"isTitle",()=>p),e(h,"isPreconnect",()=>f),e(h,"isAsyncScript",()=>y),e(h,"isImportStyles",()=>E),e(h,"isSyncScript",()=>w),e(h,"isSyncStyles",()=>T),e(h,"isPreload",()=>b),e(h,"isDeferScript",()=>S),e(h,"isPrefetchPrerender",()=>A),e(h,"META_HTTP_EQUIV_KEYWORDS",()=>m),e(h,"isOriginTrial",()=>P),e(h,"isMetaCSP",()=>v),e(h,"getWeight",()=>C),e(h,"getHeadWeights",()=>$);let d={META:10,TITLE:9,PRECONNECT:8,ASYNC_SCRIPT:7,IMPORT_STYLES:6,SYNC_SCRIPT:5,SYNC_STYLES:4,PRELOAD:3,DEFER_SCRIPT:2,PREFETCH_PRERENDER:1,OTHER:0},u={META:g,TITLE:p,PRECONNECT:f,ASYNC_SCRIPT:y,IMPORT_STYLES:E,SYNC_SCRIPT:w,SYNC_STYLES:T,PRELOAD:b,DEFER_SCRIPT:S,PREFETCH_PRERENDER:A},m=["accept-ch","content-security-policy","content-type","default-style","delegate-ch","origin-trial","x-dns-prefetch-control"];function g(e){let t=m.map(e=>`[http-equiv="${e}" i]`).join(", ");return e.matches(`meta:is([charset], ${t}, [name=viewport]), base`)}function p(e){return e.matches("title")}function f(e){return e.matches("link[rel=preconnect]")}function y(e){return e.matches("script[src][async]")}function E(e){return!!e.matches("style")&&/@import/.test(e.textContent)}function w(e){return e.matches("script:not([src][defer],[src][type=module],[src][async],[type*=json])")}function T(e){return e.matches("link[rel=stylesheet],style")}function b(e){return e.matches("link:is([rel=preload], [rel=modulepreload])")}function S(e){return e.matches("script[src][defer], script:not([src][async])[src][type=module]")}function A(e){return e.matches("link:is([rel=prefetch], [rel=dns-prefetch], [rel=prerender])")}function P(e){return e.matches('meta[http-equiv="origin-trial"i]')}function v(e){return e.matches('meta[http-equiv="Content-Security-Policy" i], meta[http-equiv="Content-Security-Policy-Report-Only" i]')}function C(e){for(let[t,n]of Object.entries(u))if(n(e))return d[t];return d.OTHER}function $(e){let t=Array.from(e.children);return t.map(e=>({element:e,weight:C(e)}))}var x={};e(x,"VALID_HEAD_ELEMENTS",()=>L),e(x,"CONTENT_TYPE_SELECTOR",()=>M),e(x,"HTTP_EQUIV_SELECTOR",()=>V),e(x,"PRELOAD_SELECTOR",()=>k),e(x,"isValidElement",()=>H),e(x,"hasValidationWarning",()=>N),e(x,"getValidationWarnings",()=>R),e(x,"getCustomValidations",()=>D);let L=new Set(["base","link","meta","noscript","script","style","template","title"]),M='meta[http-equiv="content-type" i], meta[charset]',V="meta[http-equiv]",k='link:is([rel="preload" i], [rel="modulepreload" i])';function H(e){return L.has(e.tagName.toLowerCase())}function N(e){return!!(!H(e)||e.matches(`:has(:not(${Array.from(L).join(", ")}))`)||e.matches("title:is(:nth-of-type(n+2))")||e.matches("base:has(~ base), base ~ base")||v(e)||function(e){if(!U(e))return!1;let{warnings:t}=W(e);return t.length>0}(e)||function(e){if(!I(e))return!1;let{warnings:t}=F(e);return t.length>0}(e)||function(e){if(!q(e))return!1;let{warnings:t}=j(e);return t.length>0}(e)||function(e){if(!P(e))return!1;let{warnings:t}=O(e);return t.length>0}(e)||_(e))}function R(e){let t=[],n=Array.from(e.querySelectorAll("title")),i=n.length;1!=i&&t.push({warning:`Expected exactly 1 <title> element, found ${i}`,elements:n});let a=Array.from(e.querySelectorAll("base")),s=a.length;s>1&&t.push({warning:`Expected at most 1 <base> element, found ${s}`,elements:a});let r=e.querySelector('meta[http-equiv="Content-Security-Policy" i]');r&&t.push({warning:"CSP meta tags disable the preload scanner due to a bug in Chrome. Use the CSP header instead. Learn more: https://crbug.com/1458493",element:r}),e.querySelectorAll("*").forEach(n=>{if(H(n))return;let i=n;for(;i.parentElement!=e;)i=i.parentElement;t.push({warning:`${n.tagName} elements are not allowed in the <head>`,element:i})});let o=Array.from(e.querySelectorAll('meta[http-equiv="Origin-Trial" i]'));return o.forEach(e=>{let n=O(e);0!=n.warnings.length&&t.push({warning:`Invalid origin trial token: ${n.warnings.join(", ")}`,elements:[e],element:n.payload})}),t}function D(e){return P(e)?O(e):v(e)?function(e){let t=[];return e.matches('meta[http-equiv="Content-Security-Policy-Report-Only" i]')?t.push("CSP Report-Only is forbidden in meta tags"):e.matches('meta[http-equiv="Content-Security-Policy" i]')&&t.push("meta CSP discouraged. See https://crbug.com/1458493."),{warnings:t}}(e):I(e)?F(e):q(e)?j(e):U(e)?W(e):_(e)?function(e){let t=e.getAttribute("href"),n=Y(t),i=z(e.parentElement,n);if(!i)throw Error("Expected an invalid preload, but none found.");return{warnings:[`This preload has little to no effect. ${t} is already discoverable by another ${i.tagName} element.`]}}(e):{}}function O(e){var t,n,i,a;let s={payload:null,warnings:[]},r=e.getAttribute("content");try{s.payload=function(e){let t=new Uint8Array([...atob(e)].map(e=>e.charCodeAt(0))),n=new DataView(t.buffer),i=n.getUint32(65,!1),a=JSON.parse(new TextDecoder().decode(t.slice(69,69+i)));return a.expiry=new Date(1e3*a.expiry),a}(r)}catch{return s.warnings.push("invalid token"),s}if(s.payload.expiry<new Date&&s.warnings.push("expired"),t=s.payload.origin,n=document.location.href,new URL(t).origin!==new URL(n).origin){let e=(i=s.payload.origin,a=document.location.href,i=new URL(i),(a=new URL(a)).host.endsWith(`.${i.host}`));console.log({subdomain:e,payload:s.payload}),e&&!s.payload.isSubdomain?s.warnings.push("invalid subdomain"):e||s.payload.isThirdParty||s.warnings.push("invalid third-party origin")}return s}function I(e){return e.matches('meta[http-equiv="default-style" i]')}function q(e){return e.matches(M)}function U(e){return e.matches(V)}function _(e){if(!e.matches(k))return!1;let t=e.getAttribute("href");if(!t)return!1;let n=Y(t);return null!=z(e.parentElement,n)}function z(e,t){let n=Array.from(e.querySelectorAll(`link:not(${k}), script`));return n.find(e=>{let n=e.getAttribute("href")||e.getAttribute("src");return!!n&&t==Y(n)})}function Y(e){return new URL(e,document.baseURI).href}function F(e){let t=[],n=null,i=e.getAttribute("content"),a=e.parentElement.querySelector(`link[rel~="alternate" i][rel~="stylesheet" i][title="${i}"]`);return i?a||(n={alternateStylesheets:Array.from(e.parentElement.querySelectorAll('link[rel~="alternate" i][rel~="stylesheet" i]'))},t.push(`This has no effect. No alternate stylesheet found having title="${i}".`)):t.push("This has no effect. The content attribute must be set to a valid stylesheet title."),t.push("Even when used correctly, the default-style method of setting a preferred stylesheet results in a flash of unstyled content. Use modern CSS features like @media rules instead."),{warnings:t,payload:n}}function j(e){let t=[],n=null;if(e.matches(':is(meta[charset] ~ meta[http-equiv="content-type" i])')||e.matches(":has(~ meta[charset])")){let i=e.parentElement.querySelector("meta[charset]");(n=n??{}).encodingDeclaration=i,t.push(`There can only be one meta-based character encoding declaration per document. Already found \`${i.outerHTML}\`.`)}let i=e.ownerDocument.documentElement.outerHTML.indexOf(e.outerHTML)+e.outerHTML.length;i>1024&&((n=n??{}).characterPosition=i,t.push(`The element containing the character encoding declaration must be serialized completely within the first 1024 bytes of the document. Found at byte ${i}.`));let a=null;return"utf-8"!=(a=e.matches("meta[charset]")?e.getAttribute("charset"):e.getAttribute("content")?.match(/text\/html;\s*charset=(.*)/i)?.[1]).toLowerCase()&&((n=n??{}).charset=a,t.push(`Documents are required to use UTF-8 encoding. Found "${a}".`)),t.length&&(t[length-1]=t.at(-1)+"\nLearn more: https://html.spec.whatwg.org/multipage/semantics.html#character-encoding-declaration"),{warnings:t,payload:n}}function W(e){let t=[],n=e.getAttribute("http-equiv").toLowerCase(),i=e.getAttribute("content").toLowerCase();switch(n){case"content-security-policy":case"content-security-policy-report-only":case"origin-trial":case"content-type":case"default-style":break;case"refresh":i.includes("url=")?t.push("Meta auto-redirects are discouraged. Use HTTP 3XX responses instead."):t.push("Meta auto-refreshes are discouraged unless users have the ability to disable it.");break;case"x-dns-prefetch-control":"on"==i?t.push(`DNS prefetching is enabled by default. Setting it to "${i}" has no effect.`):"off"!=i?t.push(`This is a non-standard way of disabling DNS prefetching, which is a performance optimization. Found content="${i}". Use content="off" if you have a legitimate security concern, otherwise remove it.`):t.push("This is non-standard, however most browsers support disabling speculative DNS prefetching. It should still be noted that DNS prefetching is a generally accepted performance optimization and you should only disable it if you have specific security concerns.");break;case"cache-control":case"etag":case"pragma":case"expires":case"last-modified":t.push("This doesn't do anything. Use HTTP headers for any cache directives.");break;case"x-frame-options":t.push("This doesn't do anything. Use the CSP HTTP header with the frame-ancestors directive instead.");break;case"x-ua-compatible":case"content-style-type":case"content-script-type":case"imagetoolbar":case"cleartype":case"page-enter":case"page-exit":case"site-enter":case"site-exit":case"msthemecompatible":case"window-target":t.push("This doesn't do anything. It was an Internet Explorer feature and is now deprecated.");break;case"content-language":case"language":t.push("This is non-conforming. Use the html[lang] attribute instead.");break;case"set-cookie":t.push("This is non-conforming. Use the Set-Cookie HTTP header instead.");break;case"application-name":case"author":case"description":case"generator":case"keywords":case"referrer":case"theme-color":case"color-scheme":case"viewport":case"creator":case"googlebot":case"publisher":case"robots":t.push(`This doesn't do anything. Did you mean \`meta[name=${n}]\`?`);break;case"encoding":t.push("This doesn't do anything. Did you mean `meta[charset]`?");break;case"title":t.push("This doesn't do anything. Did you mean to use the `title` tag instead?");break;case"accept-ch":case"delegate-ch":t.push("This is non-standard and may not work across browsers. Use HTTP headers instead.");break;default:t.push("This is non-standard and may not work across browsers. http-equiv is not an alternative to HTTP headers.")}return{warnings:t}}async function J(e){await e.init(),function(e,t){let n=t.getValidationWarnings(e.getHead());e.logValidationWarnings(n)}(e,x);let t=function(e,t,n){let i=e.getHead(),a=n.getHeadWeights(i).map(({element:n,weight:i})=>({weight:i,element:e.getLoggableElement(n),isValid:!t.hasValidationWarning(n),customValidations:t.getCustomValidations(n)}));e.visualizeHead("Actual",i,a);let s=Array.from(a).sort((e,t)=>t.weight-e.weight),r=document.createElement("head");return s.forEach(({element:e})=>{r.appendChild(e.cloneNode(!0))}),e.visualizeHead("Sorted",r,s),a}(e,x,h);return{actual:t.map(({element:t,weight:n,isValid:i,customValidations:a})=>(a?.payload?.expiry&&(a.payload.expiry=a.payload.expiry.toString()),{weight:n,color:e.getColor(n),selector:e.stringifyElement(t),innerHTML:t.innerHTML,isValid:i,customValidations:a}))}}async function K(){let{options:e}=await chrome.storage.sync.get("options");return new l.Options(e)}!async function(){let e=await K(),t=new r.IO(document,e),{click:n}=await chrome.storage.local.get("click");if(n)t.logElementFromSelector(JSON.parse(n)),await chrome.storage.local.remove("click");else{let e=await J(t);await chrome.storage.local.set({data:e})}}()})();